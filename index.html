<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Auction House Prices</title>
    <script src="https://wow.zamimg.com/widgets/power.js"></script>
    <style>
      * {
        padding: 0;
        margin: 0;
        font-family: Arial;
      }

      body {
        padding: 20px;
        background-color: rgb(32, 32, 32);
        color: white;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th,
      td {
        padding: 8px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }

      .grid-container {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        padding: 20px;
      }

      a {
        text-decoration: none;
      }

      .item {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }

      /* Example rarity colors */
      .common {
        color: #ffffff;
      }
      .uncommon {
        color: #1eff00;
      }
      .rare {
        color: #0070dd;
      }
      .epic {
        color: #a335ee;
      }
      .legendary {
        color: #ff8000;
      }

      .gold-icon {
        width: 16px;
        height: 16px;
        background-image: url("https://wow.zamimg.com/images/icons/money-gold.gif"); /* Path to your gold icon image */
        display: inline-block;
        background-size: contain;
        margin-right: 4px;
      }

      .price {
        color: white;
      }

      .calculation {
        display: none; /* Hide calculation by default */
      }

      .show-calculation .calculation {
        display: inline; /* Only show when this class is added */
      }

      .hide-calculation .not-calculation {
        display: none; /* Hide when this class is added */
      }
    </style>
  </head>
  <body>
    <div id="lastUpdated">Last Updated: <span id="timestamp">Loading...</span></div>
    <h1>Auction House Prices by Item and Region</h1>
    <label> <input type="checkbox" id="toggleCalculation" /> Show Price Calculations </label>
    <table id="price-table">
      <thead>
        <tr>
          <th>Item Name</th>
          <th>EU Prices</th>
          <th>US Prices</th>
          <th>TW Prices</th>
          <th>KR Prices</th>
        </tr>
      </thead>
      <tbody>
        <!-- Data rows will be inserted here by JavaScript -->
      </tbody>
    </table>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        fetchData();
        document.getElementById("toggleCalculation").addEventListener("change", function () {
          const table = document.querySelector("#price-table");
          if (this.checked) {
            table.classList.add("show-calculation");
            table.classList.add("hide-calculation");
          } else {
            table.classList.remove("show-calculation");
            table.classList.remove("hide-calculation");
          }
        });
      });

      async function fetchData() {
        // Simulating a fetch request - replace with actual fetch from your backend
        const response = await fetch("python-backend/data/latest_item_prices.json");
        const data = await response.json();

        // Update the timestamp display
        document.getElementById("timestamp").textContent = formatTimestamp(data.timestamp);

        processAndDisplayData(data);
      }

      // Helper function to format the timestamp (optional)
      function formatTimestamp(timestamp) {
        // Assuming the timestamp is in ISO format, e.g., "2024-02-08T23:52:02.887160"
        // Convert to a more readable format
        const date = new Date(timestamp);
        return date.toLocaleString("fi-FI"); // Adjust formatting as needed
      }

      function processAndDisplayData(data) {
        const itemsMap = new Map();

        // Directly process each region's top-level item and its parts
        data.data.forEach((regionData) => {
          const topLevelItem = regionData.data;
          // Ensure the top-level item is correctly identified and processed
          processTopLevelItem(topLevelItem, itemsMap, regionData.region);
          // Process parts of the top-level item
          processParts(topLevelItem.parts, itemsMap, regionData.region);
        });

        displayItems(itemsMap);
      }

      function processTopLevelItem(item, itemsMap, region) {
        const itemKey = `item-${item.id}`;
        if (!itemsMap.has(itemKey)) {
          itemsMap.set(itemKey, {
            name: item.name,
            quality: item.quality,
            prices: {},
            amountNeeded: {}, // Top-level might not need this, but keeping structure consistent
          });
        }
        // Assign the top-level item's price for the current region
        itemsMap.get(itemKey).prices[region] = item.price;
      }

      function processParts(parts, itemsMap, region) {
        parts.forEach((part) => {
          const partKey = `item-${part.id}`;
          if (!itemsMap.has(partKey)) {
            itemsMap.set(partKey, createItemEntry(part, region));
          } else {
            itemsMap.get(partKey).prices[region] = part.price;
            if (part.amount_needed) {
              itemsMap.get(partKey).amountNeeded[region] = part.amount_needed;
            }
          }

          if (part.parts) {
            processParts(part.parts, itemsMap, region);
          }
        });
      }

      function createItemEntry(part, region) {
        const entry = {
          name: part.name,
          quality: part.quality,
          prices: { [region]: part.price },
          amountNeeded: {},
        };
        if (part.amount_needed) {
          entry.amountNeeded[region] = part.amount_needed;
        }
        return entry;
      }

      function displayItems(itemsMap) {
        const tbody = document.querySelector("#price-table tbody");

        itemsMap.forEach((details, id) => {
          const row = document.createElement("tr");
          row.innerHTML = `<td><a href="https://www.wowhead.com/item=${id.split("-").pop()}" class="${getQualityClass(
            details.quality
          )}" data-wowhead="item=${id.split("-").pop()}">${details.name}</a>${
            Object.values(details.amountNeeded).some((amount) => amount)
              ? `<span class="white-text calculation"> x ${
                  Object.values(details.amountNeeded).find((amount) => amount) || "</span>"
                }`
              : ""
          }</td>
                        ${["eu", "us", "tw", "kr"]
                          .map((region) => {
                            const price = details.prices[region] || 0;
                            const amountNeeded = details.amountNeeded[region];
                            const totalPrice = amountNeeded ? price * amountNeeded : price;
                            if (amountNeeded) {
                              return `<td><span class="not-calculation">${formatGold(
                                price
                              )} <span class="gold-icon"></span></span>${
                                amountNeeded
                                  ? `<span class="calculation">${formatGold(
                                      totalPrice
                                    )} <span class="gold-icon"></span></span>`
                                  : ""
                              }</td>`;
                            } else {
                              return `<td>${formatGold(price)} <span class="gold-icon"></span></td>`;
                            }
                          })
                          .join("")}`;
          tbody.appendChild(row);
        });
      }

      function formatGold(price) {
        return Math.floor(price / 10000).toLocaleString("fi-FI");
      }

      function getQualityClass(quality) {
        const qualityClasses = {
          common: "common",
          uncommon: "uncommon",
          rare: "rare",
          epic: "epic",
          legendary: "legendary",
          artifact: "artifact",
        };
        return qualityClasses[quality] || "common";
      }
    </script>
  </body>
</html>
